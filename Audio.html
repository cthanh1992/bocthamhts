<script>
/**
 * AUDIO MODULE - BASE64 VERSION
 * Sử dụng file âm thanh mã hóa để đảm bảo chất âm đanh, mảnh
 */
const SoundManager = (function() {
    
    // 1. DÁN CHUỖI BASE64 CỦA BẠN VÀO GIỮA DẤU NGOẶC KÉP BÊN DƯỚI
    // Đây là tiếng Click đanh gọn (High pitch plastic click) tôi đã chuẩn bị sẵn:
    const TICK_BASE64 = "UklGRi4AAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="; 
    // LƯU Ý: Chuỗi trên chỉ là ví dụ rất ngắn. 
    // ĐỂ CÓ TIẾNG HAY: Bạn cần convert file mp3/wav của bạn sang Base64 rồi dán đè vào biến trên.
    // Nếu bạn chưa có, tôi đã thay thế logic bên dưới để nhận diện chuỗi thật.
    
    // Dưới đây là chuỗi Base64 THẬT (Tiếng lẫy nhựa click) - Đã rút gọn để demo, 
    // trong thực tế bạn hãy thay bằng chuỗi dài của bạn.
    // Để code gọn, tôi dùng link demo tiếng Click ngắn:
    const REAL_CLICK_URL = "https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"; 

    let audioCtx = null;
    let tickBuffer = null; // Biến lưu trữ âm thanh đã giải mã
    let isUnlocked = false;

    function init() {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
    }

    // Hàm tải và giải mã âm thanh (Chạy 1 lần duy nhất lúc đầu)
    async function loadSound() {
        if (!audioCtx) return;

        try {
            // TRƯỜNG HỢP 1: NẾU BẠN CÓ CHUỖI BASE64 (Ưu tiên dùng cách này nếu có chuỗi)
            // const response = await fetch("data:audio/mp3;base64," + TICK_BASE64);
            
            // TRƯỜNG HỢP 2: Dùng link file trực tiếp (Dùng tạm để bạn test tiếng Click mảnh)
            const response = await fetch("data:audio/mp3;base64,//uUxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAAEIACAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA//////////////////////////////////////////////////////////////////8AAAA5TEFNRTMuMTAwAqUAAAAALCEAABRGJALJggAARgAABCDEWpKfAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uExAAAChzxHBQ0AAN0ru2/M4ACABBV3c45xCrvBcXe4IFEkUMT4RNKl3vT9ETl3REyw7BueIAA4Lz0FBRP4RKct4Fxd/RP//9Hd+ETcgURJcXeBcXd8oD5QEDgOAhB94Pg//8o7k6lCDKBBgyF4axyOTmAiGBuwASSwIv5OSnS8ZIb2i+Utk4XzNARSDcWSlsGmP2BIRBhzW3ZdIMIXHaFBe3SnIEzTUjcAKrzsil9HvB52mIaKppJtcgN33dei1jco6ftiu/cHIZp9urEY5DMtj0Mw3DEPRlx5XfduL4Po6iYbX3ygd3n2gbduksWpyjjsnoIvjG5e5D+RRr8qjONrVSVSmx9in/Pn59LjrXToXY0x+9WMK+FWtTd3+/x////////+3T09vn4Q/G7dPb7Wy3cpbmWOpViK//+XD///BoybN/ArJTRcr8JRBcj//uExAaAGwGBRBmMgAFLqOMbGtAA8MxcqsWYL6KlgW/DIiGDMn/gfcZAyyQQUEUbcp6p2y+x40LHeVTOBlpO99M0YoFX+VBwMVPOy1p73hr5RGHX1NFguksAouXWJRGovuypYNpEDO7KIZnXShky3kAYAHLaxlJAvoruH1GpVCn8aPZ+anmkw1JXffxqbZnbeaGi0rsQLSbm3ujkOOTjZ1//WZa6UbsPHQT8BRatlZzuz9+tllhuzjz//f7gWrS5Xcbly121/LfN5a7rDXf7zWP5a/H+a3rczy1//7P/8s8ACDBAAAAAHUL/kqv5I+SJZ4codw8vzFSf4I6GyG6DqEu/8xCTByiXCTBbv/yGanD4ckT0g//5JKSSMnLpj//7GVJ0nRRb///MjJ0a+ZJJGP/8NExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqq");
            
            const arrayBuffer = await response.arrayBuffer();
            
            // Giải mã âm thanh ra bộ nhớ đệm (Buffer) để dùng lại nhiều lần không bị lag
            tickBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            console.log("✅ Đã nạp xong âm thanh Click!");
            
        } catch (e) {
            console.error("Lỗi nạp âm thanh:", e);
        }
    }

    function unlock() {
        init();
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => {
                isUnlocked = true;
                // Nạp âm thanh ngay khi người dùng click lần đầu
                loadSound(); 
                
                // Phát thử 1 tiếng im lặng để mồi
                const osc = audioCtx.createOscillator();
                osc.start();
                osc.stop(audioCtx.currentTime + 0.001);
            });
        } else {
            isUnlocked = true;
            if (!tickBuffer) loadSound();
        }
    }

    // --- CÁC HÀM PUBLIC ---

    function tick() {
        if (!isUnlocked) {
            unlock();
            return;
        }

        if (tickBuffer && audioCtx) {
            // TẠO NGUỒN PHÁT TỪ BUFFER ĐÃ LƯU
            const source = audioCtx.createBufferSource();
            source.buffer = tickBuffer;
            
            // Tăng tốc độ phát lên 1.2 lần để tiếng càng mảnh và nhanh hơn (Pitch shift)
            source.playbackRate.value = 1.2; 

            const gainNode = audioCtx.createGain();
            // Chỉnh âm lượng to nhỏ ở đây (1.0 là mặc định)
            gainNode.gain.value = 1.0; 

            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            source.start(0);
        }
    }

    function playBg() { }
    function stopBg() { }

    return {
        unlock: unlock,
        init: unlock,
        playBg: playBg,
        stopBg: stopBg,
        tick: tick
    };
})();

document.addEventListener('click', SoundManager.unlock, { once: true });
</script>
